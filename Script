local LogService = game:GetService("LogService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")

local LocalPlayer = Players.LocalPlayer
local PlayerName = LocalPlayer.Name

-- Settings Variables
local showTimestamp = true
local remoteLoggingEnabled = true
local filterUsername = false
local logs = {}

-- Main UI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "DevConsole_V11_Final"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- --- MAIN FRAME ---
local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 550, 0, 350)
MainFrame.Position = UDim2.new(0.5, -275, 0.4, -175)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true 
MainFrame.ClipsDescendants = true

-- --- TITLE BAR ---
local TitleBar = Instance.new("Frame", MainFrame)
TitleBar.Size = UDim2.new(1, 0, 0, 35)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
TitleBar.BorderSizePixel = 0

local TitleText = Instance.new("TextLabel", TitleBar)
TitleText.Size = UDim2.new(0, 160, 1, 0)
TitleText.Position = UDim2.new(0, 10, 0, 0)
TitleText.Text = "DEV CONSOLE+"
TitleText.Font = Enum.Font.GothamBold
TitleText.TextSize = 16 
TitleText.TextColor3 = Color3.new(1, 1, 1)
TitleText.BackgroundTransparency = 1
TitleText.TextXAlignment = Enum.TextXAlignment.Left

local SearchBox = Instance.new("TextBox", TitleBar)
SearchBox.Size = UDim2.new(0, 160, 0, 26)
SearchBox.Position = UDim2.new(1, -210, 0.5, -13)
SearchBox.PlaceholderText = "Search..."
SearchBox.Text = ""
SearchBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
SearchBox.TextColor3 = Color3.new(1, 1, 1)
SearchBox.Font = Enum.Font.GothamBold
SearchBox.TextSize = 14 
SearchBox.BorderSizePixel = 0

local CloseBtn = Instance.new("TextButton", TitleBar)
CloseBtn.Size = UDim2.new(0, 40, 1, 0)
CloseBtn.Position = UDim2.new(1, -40, 0, 0)
CloseBtn.Text = "X"
CloseBtn.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
CloseBtn.TextColor3 = Color3.new(1, 1, 1)
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.TextSize = 18

-- --- SETTINGS MENU ---
local SettingsFrame = Instance.new("Frame", MainFrame)
SettingsFrame.Size = UDim2.new(0, 220, 1, -35)
SettingsFrame.Position = UDim2.new(1, 0, 0, 35)
SettingsFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
SettingsFrame.BorderSizePixel = 1
SettingsFrame.BorderColor3 = Color3.fromRGB(60, 60, 60)
SettingsFrame.ZIndex = 50 
SettingsFrame.Visible = false

local SettingsPadding = Instance.new("UIPadding", SettingsFrame)
SettingsPadding.PaddingTop = UDim.new(0, 10)
SettingsPadding.PaddingLeft = UDim.new(0, 10)
SettingsPadding.PaddingRight = UDim.new(0, 10)

local SettingsTitle = Instance.new("TextLabel", SettingsFrame)
SettingsTitle.Size = UDim2.new(1, -40, 0, 30)
SettingsTitle.Text = "SETTINGS"
SettingsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
SettingsTitle.BackgroundTransparency = 1
SettingsTitle.Font = Enum.Font.GothamBold
SettingsTitle.TextSize = 16
SettingsTitle.TextXAlignment = Enum.TextXAlignment.Left
SettingsTitle.ZIndex = 51

local CloseSettingsBtn = Instance.new("TextButton", SettingsFrame)
CloseSettingsBtn.Size = UDim2.new(0, 35, 0, 35)
CloseSettingsBtn.Position = UDim2.new(1, -35, 0, -5)
CloseSettingsBtn.Text = "Â»"
CloseSettingsBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
CloseSettingsBtn.TextColor3 = Color3.new(1, 1, 1)
CloseSettingsBtn.Font = Enum.Font.GothamBold
CloseSettingsBtn.TextSize = 24 
CloseSettingsBtn.ZIndex = 52

local SettingsList = Instance.new("UIListLayout", SettingsFrame)
SettingsList.Padding = UDim.new(0, 12)
SettingsList.SortOrder = Enum.SortOrder.LayoutOrder

-- --- LOG SCROLL ---
local LogScroll = Instance.new("ScrollingFrame", MainFrame)
LogScroll.Size = UDim2.new(1, -10, 1, -85)
LogScroll.Position = UDim2.new(0, 5, 0, 40)
LogScroll.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
LogScroll.BorderSizePixel = 0
LogScroll.ScrollBarThickness = 8
LogScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
LogScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y 
LogScroll.ZIndex = 1

local LogPadding = Instance.new("UIPadding", LogScroll)
LogPadding.PaddingLeft = UDim.new(0, 8) 

local UIListLayout = Instance.new("UIListLayout", LogScroll)
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 4)

-- --- HELPER FUNCTIONS ---
local function serializeTable(val, indent)
    indent = indent or 1
    local tabs = string.rep("\t", indent)
    local prevTabs = string.rep("\t", indent - 1)
    if type(val) == "table" then
        local res = "{\n"
        local keys = {}
        for k in pairs(val) do table.insert(keys, k) end
        for i, k in ipairs(keys) do
            local keyStr = (type(k) == "string") and k .. " = " or (type(k) == "number" and k ~= i and "[" .. tostring(k) .. "] = " or "")
            res = res .. tabs .. keyStr .. serializeTable(val[k], indent + 1) .. (i == #keys and "" or ",") .. "\n"
        end
        return res .. prevTabs .. "}"
    elseif type(val) == "string" then return '"' .. val .. '"'
    elseif type(val) == "Instance" then return "game." .. val:GetFullName()
    else return tostring(val) end
end

local function applyFilters(text)
    local processed = text
    if filterUsername then
        processed = string.gsub(processed, PlayerName, "(*Username*)")
    end
    return processed
end

local function updateLogs()
	local searchText = SearchBox.Text:lower()
	for _, data in pairs(logs) do
		local text = showTimestamp and (data.time .. data.msg) or data.msg
        local filteredText = applyFilters(text)
		data.label.Text = filteredText
		data.label.Visible = (searchText == "" or string.find(filteredText:lower(), searchText))
	end
end

local function addLog(message, messageType)
	local timestamp = "[" .. os.date("%X") .. "] "
	local cleanMsg = tostring(message)
	local btn = Instance.new("TextButton", LogScroll)
	btn.Size = UDim2.new(1, -15, 0, 20)
	btn.AutomaticSize = Enum.AutomaticSize.Y
	btn.BackgroundTransparency = 1
	btn.Font = Enum.Font.Code
	btn.TextSize = 13
	btn.TextXAlignment = Enum.TextXAlignment.Left
	btn.TextColor3 = (messageType == "REMOTE") and Color3.fromRGB(0, 255, 255) or (messageType == Enum.MessageType.MessageError and Color3.fromRGB(255, 80, 80) or Color3.fromRGB(220, 220, 220))
	btn.TextWrapped = true
    
    local finalMsg = showTimestamp and (timestamp .. cleanMsg) or cleanMsg
	btn.Text = applyFilters(finalMsg)

	table.insert(logs, {label = btn, time = timestamp, msg = cleanMsg})
    
	local lastClick = 0
	btn.MouseButton1Down:Connect(function()
		local now = tick()
		if now - lastClick < 0.4 and setclipboard then
			setclipboard(cleanMsg)
			btn.TextColor3 = Color3.new(0, 1, 0)
			task.wait(0.2)
			btn.TextColor3 = (messageType == "REMOTE") and Color3.fromRGB(0, 255, 255) or Color3.fromRGB(220, 220, 220)
		end
		lastClick = now
	end)
end

-- --- SETTINGS TOGGLE ---
local function toggleSettings(state)
    if state == nil then state = not SettingsFrame.Visible end
    if state then
        SettingsFrame.Visible = true
        SettingsFrame:TweenPosition(UDim2.new(1, -220, 0, 35), "Out", "Quad", 0.2, true)
    else
        SettingsFrame:TweenPosition(UDim2.new(1, 0, 0, 35), "In", "Quad", 0.2, true, function() SettingsFrame.Visible = false end)
    end
end

CloseSettingsBtn.MouseButton1Click:Connect(function() toggleSettings(false) end)

-- --- HOOKS ---
if hookmetamethod then
	local oldNamecall
	oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
		local method = getnamecallmethod()
		if remoteLoggingEnabled and not checkcaller() and (method == "FireServer" or method == "InvokeServer") then
			local args = {...}
			task.spawn(function()
				local pathParts = self:GetFullName():split(".")
				local formattedPath = 'game:GetService("' .. pathParts[1] .. '")'
				for i = 2, #pathParts do formattedPath = formattedPath .. ':WaitForChild("' .. pathParts[i] .. '")' end
				addLog(string.format("-- %s\nlocal args = %s\n%s:%s(unpack(args))", self.Name, serializeTable(args), formattedPath, method), "REMOTE")
			end)
		end
		return oldNamecall(self, ...)
	end)
end

LogService.MessageOut:Connect(function(msg, msgType) addLog(msg, msgType) end)

-- --- BOTTOM BUTTONS ---
local ClearBtn = Instance.new("TextButton", MainFrame)
ClearBtn.Size = UDim2.new(0, 90, 0, 30)
ClearBtn.Position = UDim2.new(0, 10, 1, -40)
ClearBtn.Text = "Clear"
ClearBtn.BackgroundColor3 = Color3.fromRGB(80, 30, 30)
ClearBtn.TextColor3 = Color3.new(1, 1, 1)
ClearBtn.Font = Enum.Font.GothamBold
ClearBtn.TextSize = 14
ClearBtn.MouseButton1Click:Connect(function() for _, v in pairs(logs) do v.label:Destroy() end; table.clear(logs) end)

local CopyBtn = Instance.new("TextButton", MainFrame)
CopyBtn.Size = UDim2.new(0, 90, 0, 30)
CopyBtn.Position = UDim2.new(0, 110, 1, -40)
CopyBtn.Text = "Copy All"
CopyBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
CopyBtn.TextColor3 = Color3.new(1, 1, 1)
CopyBtn.Font = Enum.Font.GothamBold
CopyBtn.TextSize = 14
CopyBtn.MouseButton1Click:Connect(function()
    local full = ""
    for _, v in pairs(logs) do full = full .. v.label.Text .. "\n" end
    if setclipboard then setclipboard(full) end
end)

local SettingsBtn = Instance.new("TextButton", MainFrame)
SettingsBtn.Size = UDim2.new(0, 110, 0, 30)
SettingsBtn.Position = UDim2.new(1, -120, 1, -40)
SettingsBtn.Text = "Settings"
SettingsBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
SettingsBtn.TextColor3 = Color3.new(1, 1, 1)
SettingsBtn.Font = Enum.Font.GothamBold
SettingsBtn.TextSize = 14
SettingsBtn.MouseButton1Click:Connect(function() toggleSettings(true) end)

-- --- SETTINGS ITEMS ---
local function createToggle(text, default, callback)
    local btn = Instance.new("TextButton", SettingsFrame)
    btn.Size = UDim2.new(1, 0, 0, 40)
    btn.Text = text .. (default and ": ON" or ": OFF")
    btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.BorderSizePixel = 0
    btn.ZIndex = 51
    
    local state = default
    btn.MouseButton1Click:Connect(function()
        state = not state
        btn.Text = text .. (state and ": ON" or ": OFF")
        callback(state)
    end)
    return btn
end

createToggle("Show Time", true, function(s) showTimestamp = s; updateLogs() end)
createToggle("Remote Spy", true, function(s) remoteLoggingEnabled = s end)
createToggle("Filter User", false, function(s) filterUsername = s; updateLogs() end)

-- --- DRAGGING LOGIC ---
local dragging, dragStart, startPos
local function updateDrag(input)
	local delta = input.Position - dragStart
	MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

TitleBar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = MainFrame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then dragging = false end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
		updateDrag(input)
	end
end)

-- --- REOPEN LOGIC ---
CloseBtn.MouseButton1Click:Connect(function()
	MainFrame.Visible = false
	local rb = ScreenGui:FindFirstChild("Reopen") or Instance.new("TextButton", ScreenGui)
	rb.Name = "Reopen"; rb.Size = UDim2.new(0, 140, 0, 35); rb.Position = UDim2.new(0.5, -70, 0, 10)
	rb.Text = "OPEN CONSOLE"; rb.BackgroundColor3 = Color3.fromRGB(45, 45, 45); rb.TextColor3 = Color3.new(1, 1, 1); rb.Font = Enum.Font.GothamBold; rb.TextSize = 14
	rb.Visible = true
	rb.MouseButton1Click:Connect(function() MainFrame.Visible = true; rb.Visible = false end)
end)

-- --- CLOSE ON CLICK AWAY ---
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 and SettingsFrame.Visible then
        if input.Position.X < SettingsFrame.AbsolutePosition.X then toggleSettings(false) end
    end
end)

SearchBox:GetPropertyChangedSignal("Text"):Connect(updateLogs)
addLog("Console Ready. Double click on a log to instant copy. Turn off time stamp, or enable username protection in settings. Remote Logging requires hookmetamethod(), some executors do not support this.", Enum.MessageType.MessageInfo)
